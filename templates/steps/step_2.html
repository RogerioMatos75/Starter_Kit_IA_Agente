<div class="bg-gray-800 border border-gray-700 rounded-lg p-8">
    <h2 class="text-2xl font-bold text-white mb-2">Validação da Base de Conhecimento</h2>
    <p class="text-gray-400 mb-6">Revise os itens do manifesto gerado pela IA. Certifique-se de que todas as diretrizes principais foram criadas antes de iniciar o projeto.</p>

    <div id="validation-checklist-container" class="bg-gray-900 p-6 rounded-md border border-gray-600">
        <h3 class="text-xl font-semibold text-white mb-4">Status dos Documentos e Seções</h3>
        <div id="validation-checklist" class="space-y-3">
            <!-- O checklist será preenchido dinamicamente pelo JavaScript -->
            <p class="text-center text-blue-400">Carregando manifesto para validação...</p>
        </div>
    </div>

    <div class="mt-8">
        <h3 class="text-xl font-semibold text-white mb-4">Selecione o Tipo de Sistema</h3>
        <div class="flex flex-wrap gap-4">
            <button data-system-type="SaaS" class="system-type-btn bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-transform transform hover:scale-105">SaaS</button>
            <button data-system-type="MicroSaaS" class="system-type-btn bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg transition-transform transform hover:scale-105">MicroSaaS</button>
            <button data-system-type="PWA" class="system-type-btn bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-3 px-6 rounded-lg transition-transform transform hover:scale-105">PWA</button>
            <button data-system-type="MVP" class="system-type-btn bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg transition-transform transform hover:scale-105">MVP</button>
            <button data-system-type="ERP" class="system-type-btn bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition-transform transform hover:scale-105">ERP</button>
        </div>
    </div>

    <div class="mt-8 flex justify-end">
        <button id="approve-and-start-project-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition-transform transform hover:scale-105 disabled:bg-gray-500 disabled:cursor-not-allowed">
            Aprovar e Iniciar Projeto
        </button>
    </div>
</div>

<div class="flex gap-4 mt-8">
    <button
        data-action="prev_step"
        class="px-6 py-3 bg-gray-600 hover:bg-gray-700 text-white rounded-lg font-medium transition-colors"
    >
        ← Etapa Anterior
    </button>
    <button
        data-action="next_step"
        class="next-button px-6 py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium transition-all"
    >
        Próxima Etapa →
    </button>
</div>

<script>
    // Script para orquestrar a lógica da Etapa 2: Validação da Base de Conhecimento
    (async function() {
        const checklistDiv = document.getElementById('validation-checklist');
        const approveBtn = document.getElementById('approve-and-start-project-btn');
        const projectName = "{{ project_name }}";
        let overallValidationStatus = 'invalid'; // Inicia como inválido

        // Nomes amigáveis para os arquivos
        const friendlyFileNames = {
            '01_base_conhecimento.md': 'Base de Conhecimento Geral',
            '02_arquitetura_tecnica.md': 'Arquitetura Técnica',
            '03_regras_negocio.md': 'Regras de Negócio',
            '04_fluxos_usuario.md': 'Fluxos de Usuário',
            '05_backlog_mvp.md': 'Backlog do MVP',
            '06_autenticacao_backend.md': 'Autenticação e Backend'
        };

        if (!projectName) {
            checklistDiv.innerHTML = '<p class="text-red-500 text-center">Erro: Nome do projeto não encontrado. Por favor, volte e crie o projeto novamente.</p>';
            approveBtn.disabled = true;
            return;
        }

        // Função para renderizar a lista de validação
        function renderValidationList(validationData) {
            checklistDiv.innerHTML = ''; // Limpa o conteúdo anterior

            validationData.files.forEach(file => {
                const itemElement = document.createElement('div');
                itemElement.className = 'flex items-center p-3 rounded-md transition-all';
                
                const title = friendlyFileNames[file.name] || file.name;
                let icon;
                let statusMessage;

                if (file.status === 'valid') {
                    itemElement.classList.add('bg-gray-700', 'hover:bg-gray-600');
                    icon = `<svg class="w-6 h-6 text-green-400 mr-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
                    statusMessage = `<span class="font-medium text-white">${title}</span>`;
                } else {
                    itemElement.classList.add('bg-red-800', 'bg-opacity-50', 'hover:bg-opacity-75');
                    icon = `<svg class="w-6 h-6 text-red-400 mr-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
                    statusMessage = `<div class="flex flex-col"><span class="font-medium text-white">${title}</span><span class="text-sm text-red-300 mt-1">${file.reason}</span></div>`;
                }
                
                itemElement.innerHTML = icon + statusMessage;
                checklistDiv.appendChild(itemElement);
            });

            // Adiciona a mensagem geral
            const overallMessage = document.createElement('p');
            overallMessage.className = 'text-center mt-5 text-lg';
            if (validationData.overall_status === 'valid') {
                overallMessage.classList.add('text-green-400');
                overallMessage.textContent = 'Todos os documentos foram validados com sucesso!';
            } else {
                overallMessage.classList.add('text-yellow-400');
                overallMessage.textContent = 'Alguns documentos precisam de atenção. Revise os itens marcados em vermelho.';
            }
            checklistDiv.appendChild(overallMessage);
        }

        // Função para buscar e processar os dados de validação
        async function validateKnowledgeBase() {
            try {
                const response = await fetch('/api/supervisor/validate_knowledge_base', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ project_name: projectName })
                });

                const validationData = await response.json();

                if (!response.ok) {
                    throw new Error(validationData.message || 'Erro do servidor');
                }
                
                overallValidationStatus = validationData.overall_status;
                renderValidationList(validationData);

            } catch (error) {
                console.error('Erro ao validar a base de conhecimento:', error);
                checklistDiv.innerHTML = `<p class="text-red-500 text-center">Não foi possível carregar o status dos documentos: ${error.message}. Tente recarregar a página.</p>`;
                overallValidationStatus = 'invalid';
            } finally {
                updateApproveButtonState();
            }
        }

        // Função para atualizar o estado do botão de aprovação
        function updateApproveButtonState() {
            const selectedSystemType = ArchonDashboard.state.selectedSystemType;
            // A lógica agora permite avançar mesmo com avisos, mas não com erros de carregamento.
            // A validação final se o usuário DEVE avançar é dele.
            // O botão só fica desabilitado se a validação inicial falhar completamente ou se nenhum sistema for selecionado.
            if (overallValidationStatus !== 'invalid_initial_state' && selectedSystemType) {
                 approveBtn.disabled = false;
            } else {
                 approveBtn.disabled = true;
            }
        }
        
        // Listener para o botão de aprovação
        approveBtn.addEventListener('click', async () => {
            const selectedSystemType = ArchonDashboard.state.selectedSystemType;
            if (!selectedSystemType) {
                alert('Por favor, selecione o tipo de sistema antes de aprovar.');
                return;
            }
            
            // Adiciona um aviso se o usuário tentar avançar com problemas
            if (overallValidationStatus === 'invalid') {
                const userConfirmed = confirm('Atenção: Existem avisos nos documentos de conhecimento. Continuar mesmo assim pode afetar as próximas etapas. Deseja prosseguir?');
                if (!userConfirmed) {
                    return; // Para a execução se o usuário cancelar
                }
            }

            approveBtn.disabled = true;
            await ArchonDashboard.performSupervisorAction('approve', { system_type: selectedSystemType });
            // A ação de aprovação deve recarregar a página ou avançar o estado,
            // então não precisamos reabilitar o botão aqui.
        });

        // Sobrescreve o método selectSystemType para atualizar o estado do botão
        const originalSelectSystemType = ArchonDashboard.systemTypeSelector.selectSystemType;
        ArchonDashboard.systemTypeSelector.selectSystemType = function(type) {
            originalSelectSystemType.call(this, type);
            updateApproveButtonState();
        };

        // Execução inicial
        await validateKnowledgeBase();
        updateApproveButtonState(); // Define o estado inicial do botão

    })();
</script>