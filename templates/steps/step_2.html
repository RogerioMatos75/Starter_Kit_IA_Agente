<div class="bg-gray-800 border border-gray-700 rounded-lg p-8">
    <h2 class="text-2xl font-bold text-white mb-2">Validação da Base de Conhecimento</h2>
    <p class="text-gray-400 mb-6">Revise os itens do manifesto gerado pela IA. Certifique-se de que todas as diretrizes principais foram criadas antes de iniciar o projeto.</p>

    <div id="validation-checklist-container" class="bg-gray-900 p-6 rounded-md border border-gray-600">
        <h3 class="text-xl font-semibold text-white mb-4">Status dos Documentos e Seções</h3>
        <div id="validation-checklist" class="space-y-3">
            <!-- O checklist será preenchido dinamicamente pelo JavaScript -->
            <p class="text-center text-blue-400">Carregando manifesto para validação...</p>
        </div>
    </div>

    <div class="mt-8">
        <h3 class="text-xl font-semibold text-white mb-4">Selecione o Tipo de Sistema</h3>
        <div class="flex flex-wrap gap-4">
            <button data-system-type="SaaS" class="system-type-btn bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-transform transform hover:scale-105">SaaS</button>
            <button data-system-type="MicroSaaS" class="system-type-btn bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg transition-transform transform hover:scale-105">MicroSaaS</button>
            <button data-system-type="PWA" class="system-type-btn bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-3 px-6 rounded-lg transition-transform transform hover:scale-105">PWA</button>
            <button data-system-type="MVP" class="system-type-btn bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg transition-transform transform hover:scale-105">MVP</button>
            <button data-system-type="ERP" class="system-type-btn bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition-transform transform hover:scale-105">ERP</button>
        </div>
    </div>

    <div class="mt-8 flex justify-end">
        <button id="approve-and-start-project-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition-transform transform hover:scale-105 disabled:bg-gray-500 disabled:cursor-not-allowed">
            Aprovar e Iniciar Projeto
        </button>
    </div>
</div>

<div class="flex gap-4 mt-8">
    <button
        data-action="prev_step"
        class="px-6 py-3 bg-gray-600 hover:bg-gray-700 text-white rounded-lg font-medium transition-colors"
    >
        ← Etapa Anterior
    </button>
    <button
        data-action="next_step"
        class="next-button px-6 py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium transition-all"
    >
        Próxima Etapa →
    </button>
</div>

<script>
    // Script para orquestrar a lógica da Etapa 2: Validação da Base de Conhecimento
    (async function() {
        const checklistDiv = document.getElementById('validation-checklist');
        const approveBtn = document.getElementById('approve-and-start-project-btn');
        const projectName = "{{ project_name }}";
        let overallValidationStatus = 'invalid'; // Inicia como inválido

        const friendlyFileNames = {
            '01_base_conhecimento.md': 'Base de Conhecimento Geral',
            '02_arquitetura_tecnica.md': 'Arquitetura Técnica',
            '03_regras_negocio.md': 'Regras de Negócio',
            '04_fluxos_usuario.md': 'Fluxos de Usuário',
            '05_backlog_mvp.md': 'Backlog do MVP',
            '06_autenticacao_backend.md': 'Autenticação e Backend'
        };

        if (!projectName) {
            checklistDiv.innerHTML = '<p class="text-red-500 text-center">Erro: Nome do projeto não encontrado.</p>';
            approveBtn.disabled = true;
            return;
        }

        // --- NOVA FUNÇÃO PARA CORREÇÃO COM AGENTE ---
        async function handleRefactorClick(button, fileName, errorReason) {
            button.disabled = true;
            button.innerHTML = '<span class="animate-pulse">Corrigindo...</span>';

            try {
                const response = await fetch('/api/agents/refactor-manifest', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        project_name: projectName, 
                        file_name: fileName, 
                        error_reason: errorReason 
                    })
                });

                const result = await response.json();
                if (!response.ok) {
                    throw new Error(result.message || 'Falha na API de refatoração.');
                }

                // Sucesso! Revalida a base de conhecimento para atualizar a UI.
                await validateKnowledgeBase();

            } catch (error) {
                console.error('Erro ao acionar o agente de refatoração:', error);
                alert(`Não foi possível corrigir o arquivo: ${error.message}`);
                button.disabled = false;
                button.innerHTML = 'Tentar Novamente';
            }
        }

        function renderValidationList(validationData) {
            checklistDiv.innerHTML = '';

            validationData.files.forEach(file => {
                const itemElement = document.createElement('div');
                itemElement.className = 'flex items-center justify-between p-3 rounded-md transition-all';
                
                const title = friendlyFileNames[file.name] || file.name;
                let icon, statusMessage, actionButton = '';

                if (file.status === 'valid') {
                    itemElement.classList.add('bg-gray-700');
                    icon = `<svg class="w-6 h-6 text-green-400 mr-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
                    statusMessage = `<span class="font-medium text-white">${title}</span>`;
                } else {
                    itemElement.classList.add('bg-red-800', 'bg-opacity-60');
                    icon = `<svg class="w-6 h-6 text-red-400 mr-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
                    statusMessage = `<div class="flex flex-col"><span class="font-medium text-white">${title}</span><span class="text-sm text-red-300 mt-1">${file.reason}</span></div>`;
                    actionButton = `<button data-filename="${file.name}" data-error="${file.reason}" class="refactor-btn bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-transform transform hover:scale-105 ml-4">Corrigir com IA</button>`;
                }
                
                itemElement.innerHTML = `<div class="flex items-center">${icon}${statusMessage}</div>${actionButton}`;
                checklistDiv.appendChild(itemElement);
            });

            // Adiciona listeners para os novos botões
            document.querySelectorAll('.refactor-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const fileName = button.dataset.filename;
                    const errorReason = button.dataset.error;
                    handleRefactorClick(button, fileName, errorReason);
                });
            });

            const overallMessage = document.createElement('p');
            overallMessage.className = 'text-center mt-5 text-lg';
            if (validationData.overall_status === 'valid') {
                overallMessage.classList.add('text-green-400');
                overallMessage.textContent = 'Todos os documentos foram validados com sucesso!';
            } else {
                overallMessage.classList.add('text-yellow-400');
                overallMessage.textContent = 'Alguns documentos precisam de atenção. Use a IA para corrigi-los ou edite-os manualmente.';
            }
            checklistDiv.appendChild(overallMessage);
        }

        async function validateKnowledgeBase() {
            checklistDiv.innerHTML = '<p class="text-center text-blue-400 animate-pulse">Carregando e validando manifestos...</p>';
            try {
                const response = await fetch('/api/supervisor/validate_knowledge_base', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ project_name: projectName })
                });
                const validationData = await response.json();
                if (!response.ok) throw new Error(validationData.message || 'Erro do servidor');
                
                overallValidationStatus = validationData.overall_status;
                renderValidationList(validationData);
            } catch (error) {
                console.error('Erro ao validar a base de conhecimento:', error);
                checklistDiv.innerHTML = `<p class="text-red-500 text-center">Não foi possível carregar o status dos documentos: ${error.message}.</p>`;
                overallValidationStatus = 'invalid';
            } finally {
                updateApproveButtonState();
            }
        }

        function updateApproveButtonState() {
            const selectedSystemType = ArchonDashboard.state.selectedSystemType;
            if (overallValidationStatus === 'valid' && selectedSystemType) {
                approveBtn.disabled = false;
            } else {
                approveBtn.disabled = true;
            }
        }
        
        approveBtn.addEventListener('click', async () => {
            const selectedSystemType = ArchonDashboard.state.selectedSystemType;
            if (!selectedSystemType) {
                alert('Por favor, selecione o tipo de sistema antes de aprovar.');
                return;
            }
            if (overallValidationStatus === 'invalid') {
                const userConfirmed = confirm('Atenção: Existem problemas nos documentos. Recomenda-se corrigi-los antes de continuar. Deseja prosseguir mesmo assim?');
                if (!userConfirmed) return;
            }
            approveBtn.disabled = true;
            await ArchonDashboard.performSupervisorAction('approve', { system_type: selectedSystemType });
        });

        const originalSelectSystemType = ArchonDashboard.systemTypeSelector.selectSystemType;
        ArchonDashboard.systemTypeSelector.selectSystemType = function(type) {
            originalSelectSystemType.call(this, type);
            updateApproveButtonState();
        };

        await validateKnowledgeBase();
        updateApproveButtonState();

    })();
</script>